---
---

<div id="sid-assistant" class="sid-container">
  <button id="sid-help-btn" class="help-button" aria-label="Open assistant">?</button>
  
  <div id="sid-panel" class="sid-panel window">
    <div class="title-bar">
      <div class="title-bar-text">SID Assistant</div>
      <div class="title-bar-controls">
        <button id="sid-close-btn" aria-label="Close"></button>
      </div>
    </div>
    <div class="window-body sid-body">
      <div class="sid-content">
        <div class="sid-character">
          <img id="sid-image" src="/SID - Frame 1.webp" alt="SID Assistant" width="100" height="100" />
        </div>
        <div class="sid-speech">
          <div id="sid-speech-bubble" class="speech-bubble"></div>
        </div>
      </div>
      <div class="sid-input-area">
        <input 
          type="text" 
          id="sid-input" 
          placeholder="Type a message..."
          autocomplete="off"
        />
        <button id="sid-send-btn">Send</button>
      </div>
    </div>
  </div>
</div>

<style>
  .sid-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: var(--font-family, 'MS Sans Serif', sans-serif);
  }

  .help-button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #c0c0c0;
    border: 2px outset #dfdfdf;
    font-size: 20px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
  }

  .help-button:hover {
    background: #d4d4d4;
  }

  .help-button:active {
    border-style: inset;
  }

  .help-button.hidden {
    display: none;
  }

  .sid-panel {
    position: absolute;
    bottom: 0;
    right: 0;
    width: 320px;
    display: none;
  }

  .sid-panel.visible {
    display: block;
  }

  .sid-body {
    padding: 8px;
  }

  .sid-content {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
  }

  .sid-character {
    flex-shrink: 0;
  }

  .sid-character img {
    width: 100px;
    height: 100px;
    object-fit: contain;
    image-rendering: pixelated;
  }

  .sid-speech {
    flex-grow: 1;
    display: flex;
    align-items: flex-start;
  }

  .speech-bubble {
    background: #ffffe1;
    border: 1px solid #000;
    padding: 8px 10px;
    position: relative;
    width: 180px;
    height: 80px;
    overflow-y: auto;
    font-size: 12px;
    line-height: 1.4;
    box-shadow: inset -1px -1px #0a0a0a, inset 1px 1px #fff;
  }

  .speech-bubble::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 12px;
    width: 0;
    height: 0;
    border-top: 8px solid transparent;
    border-bottom: 8px solid transparent;
    border-right: 10px solid #000;
  }

  .speech-bubble::after {
    content: '';
    position: absolute;
    left: -8px;
    top: 13px;
    width: 0;
    height: 0;
    border-top: 7px solid transparent;
    border-bottom: 7px solid transparent;
    border-right: 9px solid #ffffe1;
  }

  .sid-input-area {
    display: flex;
    gap: 4px;
  }

  .sid-input-area input {
    flex-grow: 1;
    padding: 4px;
    font-size: 12px;
    font-family: inherit;
  }

  .sid-input-area button {
    padding: 4px 12px;
    font-size: 12px;
    font-family: inherit;
  }
</style>

<script>
  const SID_STATE_KEY = 'sid-assistant-state';

  interface SidState {
    isVisible: boolean;
    lastMessage: string;
  }

  function loadState(): SidState {
    try {
      const stored = sessionStorage.getItem(SID_STATE_KEY);
      if (stored) return JSON.parse(stored);
    } catch {}
    return { isVisible: false, lastMessage: '' };
  }

  function saveState(state: SidState) {
    sessionStorage.setItem(SID_STATE_KEY, JSON.stringify(state));
  }

  function initSidAssistant() {
    const helpBtn = document.getElementById('sid-help-btn') as HTMLButtonElement;
    const closeBtn = document.getElementById('sid-close-btn') as HTMLButtonElement;
    const panel = document.getElementById('sid-panel') as HTMLDivElement;
    const speechBubble = document.getElementById('sid-speech-bubble') as HTMLDivElement;
    const sidImage = document.getElementById('sid-image') as HTMLImageElement;
    const input = document.getElementById('sid-input') as HTMLInputElement;
    const sendBtn = document.getElementById('sid-send-btn') as HTMLButtonElement;

    let animationInterval: number | null = null;
    let typeInterval: number | null = null;
    let currentFrame = 1;

    const GREETING = "Hello! How can I help you today?";
    const DEFAULT_RESPONSE = "I don't know how to help you with that.";

    const FRAME_ANIMATION_SPEED_MS = 200;
    const TYPEWRITER_SPEED_MS = 30;

    function startFrameAnimation() {
      if (animationInterval) return;
      animationInterval = window.setInterval(() => {
        currentFrame = currentFrame === 1 ? 2 : 1;
        sidImage.src = `/SID - Frame ${currentFrame}.webp`;
      }, FRAME_ANIMATION_SPEED_MS);
    }

    function stopFrameAnimation() {
      if (animationInterval) {
        clearInterval(animationInterval);
        animationInterval = null;
      }
      sidImage.src = '/SID - Frame 1.webp';
    }

    function typeText(message: string, callback?: () => void) {
      if (typeInterval) {
        clearInterval(typeInterval);
      }
      
      speechBubble.textContent = '';
      let index = 0;
      
      startFrameAnimation();
      
      typeInterval = window.setInterval(() => {
        if (index < message.length) {
          speechBubble.textContent += message[index];
          index++;
        } else {
          clearInterval(typeInterval!);
          typeInterval = null;
          stopFrameAnimation();
          saveState({ isVisible: true, lastMessage: message });
          if (callback) callback();
        }
      }, TYPEWRITER_SPEED_MS);
    }

    function showPanel(skipGreeting = false) {
      helpBtn.classList.add('hidden');
      panel.classList.add('visible');
      if (!skipGreeting) {
        typeText(GREETING);
      }
      saveState({ isVisible: true, lastMessage: speechBubble.textContent || '' });
    }

    function hidePanel() {
      panel.classList.remove('visible');
      helpBtn.classList.remove('hidden');
      
      if (typeInterval) {
        clearInterval(typeInterval);
        typeInterval = null;
      }
      stopFrameAnimation();
      speechBubble.textContent = '';
      saveState({ isVisible: false, lastMessage: '' });
    }

    function handleSend() {
      const message = input.value.trim();
      if (!message) return;
      
      input.value = '';
      typeText(DEFAULT_RESPONSE);
    }

    function restoreState() {
      const state = loadState();
      if (state.isVisible) {
        helpBtn.classList.add('hidden');
        panel.classList.add('visible');
        speechBubble.textContent = state.lastMessage;
      }
    }

    helpBtn.addEventListener('click', () => showPanel());
    closeBtn.addEventListener('click', hidePanel);
    sendBtn.addEventListener('click', handleSend);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        handleSend();
      }
    });

    restoreState();
  }

  initSidAssistant();

  document.addEventListener('astro:after-swap', initSidAssistant);
</script>
