---
import MainLayout from "./MainLayout.astro";
import SidAssistant from '../components/SidAssistant.tsx';
import DarkModeToggle from '../components/DarkModeToggle.astro';
import { getImage } from "astro:assets";
import type { ImageMetadata } from "astro";

import sidFrame1Src from '../assets/SID/SID - Frame 1.png';
import sidFrame2Src from '../assets/SID/SID - Frame 2.png';
import sidHorror1Src from '../assets/SID/SID - Horror 1.png';
import sidHorror2Src from '../assets/SID/SID - Horror 2.png';
import helpIconSrc from '../assets/Icons/Help Icon.png';

const SID_IMAGE_SIZE = 200;

async function getOptimizedImage(src: ImageMetadata): Promise<string> {
  return (await getImage({ src, format: 'webp', width: SID_IMAGE_SIZE })).src;
}

const sidFrames = await Promise.all([sidFrame1Src, sidFrame2Src].map(getOptimizedImage));
const sidHorrorFrames = await Promise.all([sidHorror1Src, sidHorror2Src].map(getOptimizedImage));
const sidHelpIcon = await getOptimizedImage(helpIconSrc);

const { title = "Eidolon Capital Intranet" } = Astro.props;
const pathname = Astro.url.pathname;
---

<MainLayout title={title}>
  <div class="window flex flex-col">
    <div class="title-bar">
      <div class="title-bar-text">{title}</div>
      <div class="title-bar-controls">
        <DarkModeToggle />
      </div>
    </div>
    <div class="window-body flex-grow">
      <nav>
        <menu role="tablist">
          <li role="tab" aria-selected={pathname.startsWith("/dashboard")}><a href="/dashboard">Dashboard</a></li>
          <li role="tab" aria-selected={pathname.startsWith("/employees")}><a href="/employees">Employees</a></li>
          <li role="tab" aria-selected={pathname.startsWith("/anomalies")}><a href="/anomalies">Anomalies</a></li>
          <li role="tab" aria-selected={pathname.startsWith("/organizations")}>
            <a href="/organizations">Organizations</a>
          </li>
        </menu>
      </nav>
      <main>
        <slot />
      </main>
    </div>
    <div class="status-bar mt-auto" role="contentinfo">
      <div class="status-bar-field">Eidolon Capital Intranet Portal v1.0</div>
      <div class="status-bar-field">System Status: OPERATIONAL</div>
    </div>
  </div>
  <SidAssistant 
    frames={sidFrames} 
    horrorFrames={sidHorrorFrames} 
    helpIcon={sidHelpIcon}
    client:load 
    transition:persist 
  />
</MainLayout>

<style>
  .window {
    width: 100%;
    min-height: 80vh;
  }

  @media (min-width: 768px) {
    .window {
      width: 80vw;
      max-width: 1400px;
      margin: 0 auto;
    }
  }
</style>
